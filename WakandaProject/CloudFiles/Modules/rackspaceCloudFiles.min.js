"use strict";var _,Account,ACCOUNT_LOCATIONS,authenticate,Container,ContainerFile,extractCustomMetaData,FileList,fileMimeType,getContainerCdnMetaData,getContainerFileList,getFileMD5,HEADER,login,mimeType,RACKSPACE_DEFAULTS,setGetFileMD5Function;_=require("underscore"),http=require("http"),httpRequests=require("httpRequests"),fileMimeType=require("mimeTypes"),HEADER=http.HEADER_FIELD_NAMES,ACCOUNT_LOCATIONS={UK:"UK",US:"US"},Object.freeze(ACCOUNT_LOCATIONS),DELETE_OPTIONS={DELETE_EVEN_IF_NOT_EMPTY:"DELETE_EVEN_IF_NOT_EMPTY",DELETE_ONLY_IF_EMPTY:"DELETE_IF_EMPTY_ONLY"},DELETE_OPTIONS.FORCE_DELETE=DELETE_OPTIONS.DELETE_EVEN_IF_NOT_EMPTY,Object.freeze(DELETE_OPTIONS),RACKSPACE_DEFAULTS={RETRIEVAL_BATCH_LIMIT:1e4},Object.freeze(RACKSPACE_DEFAULTS),Account=function(b,c,d){this.username=b,this.apiKey=c,this.accountLocation=typeof d=="string"&&ACCOUNT_LOCATIONS.hasOwnProperty(d)?d:ACCOUNT_LOCATIONS.US},extractCustomMetaData=function(b,c){var d;return d=_.chain(_.pairs(b)).filter(function(a){return a[0].indexOf(c)===0}).map(function(a){return[a[0].replace(c,""),a[1]]}).object().value(),d},authenticate=function(b){var c,d;switch(b.accountLocation){case ACCOUNT_LOCATIONS.UK:c="https://lon.identity.api.rackspacecloud.com/v1.0";break;case ACCOUNT_LOCATIONS.US:c="https://identity.api.rackspacecloud.com/v1.0"}return d=httpRequests.get(c).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_USER,b.username),a.setRequestHeader(HEADER.X_AUTH_KEY,b.apiKey)}).send(),b._authToken=d.getResponseHeader(HEADER.X_AUTH_TOKEN),b._CDNManagementUrl=d.getResponseHeader(HEADER.X_CDN_MANAGEMENT_URL),b._storageToken=d.getResponseHeader(HEADER.X_STORAGE_TOKEN),b._storageUrl=d.getResponseHeader(HEADER.X_STORAGE_URL),b},Container=function(b,c){if(c.indexOf("/")>=0)throw new Error("Could not create a rackspace container object with a name of '"+containerName+"'. Container names cannot contain forward slash characters.");this._account=b,this._name=c,this._encodedName=encodeURIComponent(this._name),this._fullPath=this._account._storageUrl+"/"+this._encodedName},ContainerList=function(b,c){c=_.isNumber(c)&&c>0&&c<=RACKSPACE_DEFAULTS.RETRIEVAL_BATCH_LIMIT?c:RACKSPACE_DEFAULTS.RETRIEVAL_BATCH_LIMIT,this._account=b,this._list=null,this._batchLimit=c},getAccountContainerList=function(b,c,d){var e,f;f=httpRequests.get(b._storageUrl+"?format=json&limit="+c+(d?"&marker="+d:"")).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,b._authToken)}).setAuthentication(authenticate,b).send(),e=JSON.parse(f.responseText);if(!_.isArray(e))throw new Error("Could not parse the response when getting the container listing for a rackspace account.");return e},getContainerCdnMetaData=function(b){var c;c=httpRequests.head(b._account._CDNManagementUrl+"/"+b._encodedName).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,b._account._authToken)}).setAuthentication(authenticate,b._account).send(),b._cdnSslUri=c.getResponseHeader(HEADER.X_CDN_SSL_URI),b._cdnUri=c.getResponseHeader(HEADER.X_CDN_URI),b._cdnStreamingUri=c.getResponseHeader(HEADER.X_CDN_STREAMING_URI),b._cdniOSUri=c.getResponseHeader(HEADER.X_CDN_IOS_URI)},FileList=function(b,c){c=_.isNumber(c)&&c>0&&c<=RACKSPACE_DEFAULTS.RETRIEVAL_BATCH_LIMIT?c:RACKSPACE_DEFAULTS.RETRIEVAL_BATCH_LIMIT,this._container=b,this._list=null,this._batchLimit=c},getContainerFileList=function(b,c,d){var e,f;f=httpRequests.get(b._fullPath+"?format=json&limit="+c+(d?"&marker="+d:"")).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,b._account._authToken)}).setAuthentication(authenticate,b._account).send(),e=JSON.parse(f.responseText);if(!_.isArray(e))throw new Error("Could not parse the response when getting the file listing for a rackspace container named '"+b._name+"'.");return e},ContainerFile=function(b,c){this._container=b,this._fileName=c,this._encodedFileName=encodeURIComponent(this._fileName),this._fullPath=this._container._fullPath+"/"+this._encodedFileName},login=function(b,c,d){return authenticate(new Account(b,c,d))},setGetFileMD5Function=function(b){getFileMD5=b},Account.prototype.container=function(b){return new Container(this,b)},Account.prototype.containerList=function(b){return new ContainerList(this,b)},Account.prototype.getInfo=function(){var b=this,c,d;return d=httpRequests.head(this._storageUrl).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,b._authToken)}).setAuthentication(authenticate,this).send(),c=_.chain(http.responseHeadersToObject(d)).pick(HEADER.X_ACCOUNT_BYTES_USED,HEADER.X_ACCOUNT_CONTAINER_COUNT,HEADER.X_ACCOUNT_OBJECT_COUNT).pairs().map(function(a){var b=[a[0].replace(HEADER.X_ACCOUNT_BYTES_USED,"bytesUsed").replace(HEADER.X_ACCOUNT_CONTAINER_COUNT,"containerCount").replace(HEADER.X_ACCOUNT_OBJECT_COUNT,"fileCount"),Number(a[1])];return b}).object().value(),c},Container.prototype.cdniOSUrl=function(){return _.isString(this._cdniOSUri)&&this._cdniOSUri!==""?this._cdniOSUri:(getContainerCdnMetaData(this),this._cdniOSUri)},Container.prototype.cdnSslUrl=function(){return _.isString(this._cdnSslUri)&&this._cdnSslUri!==""?this._cdnSslUri:(getContainerCdnMetaData(this),this._cdnSslUri)},Container.prototype.cdnStreamingUrl=function(){return _.isString(this._cdnStreamingUri)&&this._cdnStreamingUri!==""?this._cdnStreamingUri:(getContainerCdnMetaData(this),this._cdnStreamingUri)},Container.prototype.cdnUrl=function(){return _.isString(this._cdnUri)&&this._cdnUri!==""?this._cdnUri:(getContainerCdnMetaData(this),this._cdnUri)},Container.prototype.create=function(){var b=this;return httpRequests.put(this._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,b._account._authToken)}).setAuthentication(authenticate,this._account).send(),this},Container.prototype.disableCDN=function(){var b=this;return httpRequests.put(this._account._CDNManagementUrl+"/"+this._encodedName).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,b._account._authToken),a.setRequestHeader(HEADER.X_CDN_ENABLED,"False")}).setAuthentication(authenticate,this._account).send(),delete this._cdnSslUri,delete this._cdnUri,delete this._cdnStreamingUri,delete this._cdniOSUri,this},Container.prototype.enableCDN=function(){var b=this,c;return c=httpRequests.put(this._account._CDNManagementUrl+"/"+this._encodedName).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,b._account._authToken),a.setRequestHeader(HEADER.X_CDN_ENABLED,"True")}).setAuthentication(authenticate,this._account).send(),this._cdnSslUri=c.getResponseHeader(HEADER.X_CDN_SSL_URI),this._cdnUri=c.getResponseHeader(HEADER.X_CDN_URI),this._cdnStreamingUri=c.getResponseHeader(HEADER.X_CDN_STREAMING_URI),this._cdniOSUri=c.getResponseHeader(HEADER.X_CDN_IOS_URI),this},Container.prototype.file=function(b){return new ContainerFile(this,b)},Container.prototype.fileList=function(b){return new FileList(this,b)},Container.prototype.getInfo=function(){var b,c=this,d;return d=httpRequests.head(this._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,c._account._authToken)}).setAuthentication(authenticate,this._account).send(),b=_.chain(http.responseHeadersToObject(d)).pick(HEADER.X_CONTAINER_OBJECT_COUNT,HEADER.X_CONTAINER_BYTES_USED).pairs().map(function(a){return[a[0].replace(HEADER.X_CONTAINER_BYTES_USED,"bytesUsed").replace(HEADER.X_CONTAINER_OBJECT_COUNT,"fileCount"),Number(a[1])]}).object().value(),b},Container.prototype.getMetaData=function(){var b=this,c;return c=httpRequests.head(this._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,b._account._authToken)}).setAuthentication(authenticate,this._account).send(),extractCustomMetaData(http.responseHeadersToObject(c),HEADER.X_CONTAINER_META)},Container.prototype.remove=function(b){function f(){var a;return a=httpRequests.del(d._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,d._account._authToken)}).setAuthentication(authenticate,d._account).send(),a}var c,d=this,e;b=_.isString(b)&&DELETE_OPTIONS.hasOwnProperty(b)?b:DELETE_OPTIONS.DELETE_ONLY_IF_EMPTY;try{e=f()}catch(g){if(!(g instanceof httpRequests.RequestError))throw g;if(g.xhr.status!==http.STATUS_CODES.NOT_FOUND){if(g.xhr.status!==http.STATUS_CODES.CONFLICT||b!==DELETE_OPTIONS.DELETE_EVEN_IF_NOT_EMPTY)throw e.status===http.STATUS_CODES.CONFLICT?new Error("Could not delete a rackspace container named '"+this._name+"' because it is not empty."):g;c=this.fileList().get();while(!c.isAtEnd())c.currentFile().remove(),c.goToNextFile();try{e=f()}catch(h){if(!(h instanceof httpRequests.RequestError)||h.xhr.status!==http.STATUS_CODES.NOT_FOUND)throw h}}}return this},Container.prototype.removeMetaData=function(b){var c=this;return httpRequests.post(this._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,c._account._authToken),b.forEach(function(b){a.setRequestHeader(HEADER.X_REMOVE_CONTAINER_META+b,"remove")})}).setAuthentication(authenticate,this._account).send(),this},Container.prototype.setMetaData=function(b){var c=this;return httpRequests.post(this._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,c._account._authToken),Object.keys(b).forEach(function(c){a.setRequestHeader(HEADER.X_CONTAINER_META+c,b[c])})}).setAuthentication(authenticate,this._account).send(),this},ContainerFile.prototype.copyTo=function(b){var c=this;return httpRequests.put(b._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,c._container._account._authToken),a.setRequestHeader(HEADER.X_COPY_FROM,"/"+c._container._name+"/"+c._fileName)}).setAuthentication(authenticate,this._container._account).send(),this},ContainerFile.prototype.download=function(b,c){var d,e,f=0,g=this,h,i;c=_.isNumber(c)&&c>0?c:512e3,h=BinaryStream(b,"Write");try{do{d=!1;try{i=httpRequests.get(this._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,g._container._account._authToken),a.responseType="blob",a.setRequestHeader(HEADER.RANGE,"bytes="+f+"-"+(f+c-1))}).setAuthentication(authenticate,this._container._account).send()}catch(j){if(j instanceof httpRequests.RequestError){i=j.xhr;if(j.xhr.status===http.STATUS_CODES.RANGE_NOT_SATISFIABLE)e=http.responseHeadersToObject(j.xhr).Etag,d=!0;else if(j.xhr.status!==http.STATUS_CODES.PARTIAL_CONTENT)throw j}}d||(h.putBlob(i.response),f+=c)}while(!d)}finally{h.close()}if(_.isFunction(getFileMD5)&&getFileMD5(b)!==e)throw new Error("The md5 of the downloaded file does not match the eTag sent from rackspace. File path: "+b.path);return this},ContainerFile.prototype.getMetaData=function(){var b=this,c;return c=httpRequests.head(this._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,b._container._account._authToken)}).setAuthentication(authenticate,this._container._account).send(),extractCustomMetaData(http.responseHeadersToObject(c),HEADER.X_OBJECT_META)},ContainerFile.prototype.moveTo=function(b){return this.copyTo(b),this.remove(),this},ContainerFile.prototype.remove=function(){var b=this;try{httpRequests.del(this._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,b._container._account._authToken)}).setAuthentication(authenticate,this._container._account).send()}catch(c){if(c instanceof httpRequests.RequestError&&c.xhr.status!==http.STATUS_CODES.NOT_FOUND)throw c}return this},ContainerFile.prototype.setMetaData=function(b){var c=this;return httpRequests.post(this._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,c._container._account._authToken),Object.keys(b).forEach(function(c){a.setRequestHeader(HEADER.X_OBJECT_META+c,b[c])})}).setAuthentication(authenticate,this._container._account).send(),this},ContainerFile.prototype.upload=function(b,c){var d=this;return c=c?c:fileMimeType.lookup(b.name),httpRequests.put(this._fullPath).setHeaders(function(a){a.setRequestHeader(HEADER.X_AUTH_TOKEN,d._container._account._authToken),_.isFunction(getFileMD5)&&a.setRequestHeader(HEADER.ETAG,getFileMD5(b)),a.setRequestHeader(HEADER.CONTENT_TYPE,c)}).setAuthentication(authenticate,this._container._account).send(b),this},ContainerList.prototype.currentContainer=function(){if(!_.isArray(this._list))throw new Error("The get method must be called for the container list before attempting to get the current container.");return this._currentIndex<0||this._currentIndex>=this._list.length?null:this._account.container(this._list[this._currentIndex].name)},ContainerList.prototype.currentContainerInfo=function(){if(!_.isArray(this._list))throw new Error("The get method must be called for the container list before attempting to get info for the current container.");return this._currentIndex<0||this._currentIndex>=this._list.length?null:this._list[this._currentIndex]},ContainerList.prototype.get=function(){return this._list=getAccountContainerList(this._account,this._batchLimit),this._currentIndex=this._list.length===0?-1:0,this},ContainerList.prototype.goToNextContainer=function(){if(!_.isArray(this._list))throw new Error("The get method must be called for the container list before attempting to go to the next container.");return this._currentIndex>=this._list.length?this:(this._currentIndex>=0&&this._currentIndex<this._list.length&&this._currentIndex++,this._currentIndex===this._list.length&&this._list.length>0&&(this._list=getAccountContainerList(this._account,this._batchLimit,this._list[this._list.length-1].name),this._currentIndex=this._list.length===0?-1:0),this)},ContainerList.prototype.isAtEnd=function(){if(!_.isArray(this._list))throw new Error("The get method must be called for the container list before attempting to determine if you're at the end of the list.");return this._currentIndex<0||this._currentIndex>=this._list.length},ContainerList.prototype.isNotAtEnd=function(){return!this.isAtEnd()},FileList.prototype.currentFile=function(){if(!_.isArray(this._list))throw new Error("The get method must be called for the file list before attempting to get the current file.");return this._currentIndex<0||this._currentIndex>=this._list.length?null:this._container.file(this._list[this._currentIndex].name)},FileList.prototype.currentFileInfo=function(){if(!_.isArray(this._list))throw new Error("The get method must be called for the file list before attempting to get info for the current file.");return this._currentIndex<0||this._currentIndex>=this._list.length?null:this._list[this._currentIndex]},FileList.prototype.get=function(){return this._list=getContainerFileList(this._container,this._batchLimit),this._currentIndex=this._list.length===0?-1:0,this},FileList.prototype.goToNextFile=function(){if(!_.isArray(this._list))throw new Error("The get method must be called for the file list before attempting to go to the next file.");return this._currentIndex>=this._list.length?this:(this._currentIndex>=0&&this._currentIndex<this._list.length&&this._currentIndex++,this._currentIndex===this._list.length&&this._list.length>0&&(this._list=getContainerFileList(this._container,this._batchLimit,this._list[this._list.length-1].name),this._currentIndex=this._list.length===0?-1:0),this)},FileList.prototype.isAtEnd=function(){if(!_.isArray(this._list))throw new Error("The get method must be called for the file list before attempting to determine if you're at the end of the list.");return this._currentIndex<0||this._currentIndex>=this._list.length},FileList.prototype.isNotAtEnd=function(){return!this.isAtEnd()},exports.ACCOUNT_LOCATIONS=ACCOUNT_LOCATIONS,exports.DELETE_OPTIONS=DELETE_OPTIONS,exports.login=login,exports.setGetFileMD5Function=setGetFileMD5Function